name: üåßÔ∏è Rain.gg 24/7 Monitor

on:
  # ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÉŸÑ 5 ÿØŸÇÿßÿ¶ŸÇ
  schedule:
    - cron: '*/5 * * * *'
  
  # ÿ™ÿ¥ÿ∫ŸäŸÑ ŸäÿØŸàŸä
  workflow_dispatch:
  
  # ÿ™ÿ¥ÿ∫ŸäŸÑ ÿπŸÜÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸàÿØ
  push:
    branches: [ main ]

# ÿßŸÑÿ£ÿ∞ŸàŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ÿ™ÿ≠ÿØŸäÿ´ ÿ•ŸÑŸâ Node.js 20
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          
          # ÿ•ŸÜÿ¥ÿßÿ° package.json ŸÖÿ≠ÿØÿ´
          cat > package.json << 'EOF'
          {
            "name": "rain-monitor",
            "version": "1.0.0",
            "description": "24/7 Rain.gg Monitor",
            "main": "monitor.js",
            "scripts": {
              "start": "node monitor.js"
            },
            "dependencies": {
              "axios": "^1.6.0",
              "puppeteer": "^24.1.1"
            },
            "engines": {
              "node": ">=18.0.0"
            },
            "keywords": ["monitor", "rain.gg", "automation"],
            "author": "GitHub Actions",
            "license": "MIT"
          }
          EOF
          
          # ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖŸäÿ© ŸÑŸÄ puppeteer ÿ£ŸàŸÑÿßŸã
          echo "üîÑ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc1 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            lsb-release \
            wget \
            xdg-utils
          
          # ÿ™ÿ´ÿ®Ÿäÿ™ npm packages ŸÖÿπ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ
          echo "üìö Installing npm packages..."
          npm install --no-audit --no-fund
          
          echo "‚úÖ Dependencies installed successfully"
      
      - name: üöÄ Create monitoring script
        run: |
          echo "üìù Creating monitoring script..."
          
          cat > monitor.js << 'EOF'
          const axios = require('axios');
          const puppeteer = require('puppeteer');
          const fs = require('fs').promises;
          const { execSync } = require('child_process');
          
          console.log('üöÄ Rain Monitor Script Starting...');
          console.log('Node Version:', process.version);
          console.log('Puppeteer Version:', require('puppeteer/package.json').version);
          
          // Discord webhook (optional)
          const WEBHOOK_URL = process.env.DISCORD_WEBHOOK || '';
          
          // Statistics file
          const STATS_FILE = 'stats.json';
          
          // Timeout configurations
          const TIMEOUTS = {
            navigation: 45000,
            browser: 60000,
            request: 10000
          };
          
          /**
           * Initialize or load statistics
           */
          async function loadStats() {
            try {
              const statsData = await fs.readFile(STATS_FILE, 'utf8');
              return JSON.parse(statsData);
            } catch (error) {
              console.log('üìä Creating new stats file');
              const initialStats = {
                checks: 0,
                rains: 0,
                lastRain: null,
                lastCheck: null,
                createdAt: new Date().toISOString(),
                updatedAt: null,
                errors: 0
              };
              await saveStats(initialStats);
              return initialStats;
            }
          }
          
          /**
           * Save statistics to file
           */
          async function saveStats(stats) {
            try {
              stats.updatedAt = new Date().toISOString();
              await fs.writeFile(STATS_FILE, JSON.stringify(stats, null, 2));
              console.log('üíæ Stats saved');
              return true;
            } catch (error) {
              console.error('‚ùå Failed to save stats:', error.message);
              return false;
            }
          }
          
          /**
           * Send Discord notification
           */
          async function sendDiscordNotification(message, isRain = false) {
            if (!WEBHOOK_URL || !WEBHOOK_URL.includes('discord.com')) {
              return false;
            }
            
            try {
              const payload = isRain ? {
                content: "@everyone üåßÔ∏è **RAIN DETECTED ON RAIN.GG!**",
                embeds: [{
                  title: "üö® RAIN EVENT LIVE!",
                  description: "Quick! Join the rain event now!",
                  color: 3066993,
                  url: "https://rain.gg",
                  timestamp: new Date().toISOString(),
                  footer: { text: "24/7 Monitor ‚Ä¢ Auto-detected" },
                  fields: [
                    { name: "Status", value: "LIVE üî¥", inline: true },
                    { name: "Action", value: "[Join Now](https://rain.gg)", inline: true }
                  ]
                }]
              } : {
                content: message,
                embeds: [{
                  title: "Monitor Status",
                  description: message,
                  color: 3447003,
                  timestamp: new Date().toISOString()
                }]
              };
              
              const response = await axios.post(WEBHOOK_URL, payload, {
                timeout: TIMEOUTS.request
              });
              
              console.log('üì® Discord notification sent');
              return true;
            } catch (error) {
              console.log('‚ö†Ô∏è Discord notification failed:', error.message);
              return false;
            }
          }
          
          /**
           * Update HTML status page
           */
          async function updateHTML(stats) {
            try {
              let html;
              const htmlPath = 'index.html';
              
              // Try to read existing HTML
              try {
                html = await fs.readFile(htmlPath, 'utf8');
              } catch (error) {
                console.log('Creating basic HTML template');
                html = `<!DOCTYPE html>
                <html>
                <head><meta charset="UTF-8"><title>Rain Monitor</title>
                <style>body{font-family:Arial;padding:20px;background:#0f172a;color:white;}
                .stat{background:#1e293b;padding:15px;margin:10px;border-radius:8px;}
                .rain{color:#38bdf8;font-weight:bold;}</style></head>
                <body><h1>üåßÔ∏è Rain Monitor</h1>
                <div class="stat">Last Check: <span id="lastCheck">Loading...</span></div>
                <div class="stat">Rain Events: <span id="rainCount">0</span></div>
                <div class="stat">Total Checks: <span id="totalChecks">0</span></div>
                <div class="stat">Last Rain: <span id="lastRain">Never</span></div>
                <div class="stat">Status: <span class="rain">‚óè ACTIVE</span></div>
                </body></html>`;
              }
              
              // Format time helper
              const formatTime = (dateStr) => {
                if (!dateStr) return 'Never';
                try {
                  const date = new Date(dateStr);
                  return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  });
                } catch (e) {
                  return dateStr;
                }
              };
              
              // Update values
              const replacements = {
                'id="lastCheck"[^>]*>([^<]*)<': 
                  `id="lastCheck">${formatTime(new Date().toISOString())}<`,
                'id="rainCount"[^>]*>([^<]*)<': 
                  `id="rainCount">${stats.rains || 0}<`,
                'id="totalChecks"[^>]*>([^<]*)<': 
                  `id="totalChecks">${stats.checks || 0}<`,
                'id="lastRain"[^>]*>([^<]*)<': 
                  `id="lastRain">${formatTime(stats.lastRain)}<`
              };
              
              for (const [pattern, replacement] of Object.entries(replacements)) {
                html = html.replace(new RegExp(pattern), replacement);
              }
              
              // Save updated HTML
              await fs.writeFile(htmlPath, html);
              console.log('‚úÖ HTML page updated');
              return true;
              
            } catch (error) {
              console.log('‚ö†Ô∏è HTML update skipped:', error.message);
              return false;
            }
          }
          
          /**
           * Check for rain on rain.gg
           */
          async function checkForRain() {
            console.log('üîç Starting rain check...');
            let browser = null;
            let success = false;
            let rainDetected = false;
            
            try {
              // Load current stats
              let stats = await loadStats();
              stats.checks = (stats.checks || 0) + 1;
              
              console.log('üåê Launching browser...');
              
              // Launch browser with optimized settings
              browser = await puppeteer.launch({
                headless: 'new',
                args: [
                  '--no-sandbox',
                  '--disable-setuid-sandbox',
                  '--disable-dev-shm-usage',
                  '--disable-accelerated-2d-canvas',
                  '--disable-gpu',
                  '--single-process'
                ],
                timeout: TIMEOUTS.browser,
                defaultViewport: { width: 1366, height: 768 }
              });
              
              const page = await browser.newPage();
              
              // Set realistic user agent
              await page.setUserAgent(
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 ' +
                '(KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
              );
              
              // Set timeouts
              page.setDefaultNavigationTimeout(TIMEOUTS.navigation);
              page.setDefaultTimeout(TIMEOUTS.navigation);
              
              // Navigate to rain.gg
              console.log('üì° Navigating to rain.gg...');
              await page.goto('https://rain.gg', {
                waitUntil: 'networkidle0',
                timeout: TIMEOUTS.navigation
              });
              
              // Wait for content to load
              await page.waitForTimeout(3000);
              
              // Get page content
              const pageContent = await page.content();
              const pageText = await page.evaluate(() => {
                return document.body.innerText || '';
              });
              
              // Log page status
              console.log('üìÑ Page loaded, length:', pageText.length, 'chars');
              
              // Check for rain indicators
              const rainIndicators = [
                'Grab your umbrellas!',
                'Join free rain',
                'Join now',
                'Join the rain',
                'Rain Pool',
                'for free'
              ];
              
              let foundIndicators = [];
              for (const indicator of rainIndicators) {
                if (pageText.includes(indicator)) {
                  foundIndicators.push(indicator);
                }
              }
              
              console.log('üéØ Found indicators:', foundIndicators);
              
              // Determine if rain is happening
              // We need at least 2 key indicators
              const hasUmbrella = pageText.includes('Grab your umbrellas!');
              const hasJoin = pageText.includes('Join free rain') || 
                            pageText.includes('Join now');
              const hasRainPool = pageText.includes('Rain Pool');
              
              rainDetected = (hasUmbrella && hasJoin) || 
                            (hasUmbrella && hasRainPool) ||
                            (foundIndicators.length >= 3);
              
              console.log('üåßÔ∏è Rain detected:', rainDetected);
              console.log('   - Has umbrella text:', hasUmbrella);
              console.log('   - Has join text:', hasJoin);
              console.log('   - Has rain pool:', hasRainPool);
              
              // If rain detected, handle it
              if (rainDetected) {
                console.log('üéâ RAIN EVENT DETECTED!');
                stats.rains = (stats.rains || 0) + 1;
                stats.lastRain = new Date().toISOString();
                
                // Send Discord notification
                await sendDiscordNotification('Rain detected!', true);
                
                // Try to extract additional info
                try {
                  const percentageMatch = pageText.match(/(\d+(?:\.\d+)?)% of the Rain Pool/);
                  const prizeMatch = pageText.match(/win\s+([\d,\.]+)\s+for free/);
                  
                  if (percentageMatch) {
                    console.log('üíß Percentage found:', percentageMatch[1], '%');
                  }
                  if (prizeMatch) {
                    console.log('üí∞ Prize value:', prizeMatch[1]);
                  }
                } catch (infoError) {
                  // Ignore extraction errors
                }
              } else {
                console.log('‚òÄÔ∏è No rain detected at this time');
              }
              
              // Update stats and HTML
              stats.lastCheck = new Date().toISOString();
              await saveStats(stats);
              await updateHTML(stats);
              
              success = true;
              
            } catch (error) {
              console.error('‚ùå Error during rain check:', error.message);
              
              // Update error count in stats
              try {
                let stats = await loadStats();
                stats.errors = (stats.errors || 0) + 1;
                stats.lastCheck = new Date().toISOString();
                await saveStats(stats);
                await updateHTML(stats);
              } catch (statsError) {
                console.error('Failed to update error stats:', statsError.message);
              }
              
              // Send error notification if configured
              if (WEBHOOK_URL) {
                await sendDiscordNotification(`Monitor error: ${error.message}`);
              }
              
            } finally {
              // Close browser if it exists
              if (browser) {
                try {
                  await browser.close();
                  console.log('üîí Browser closed');
                } catch (closeError) {
                  console.log('‚ö†Ô∏è Error closing browser:', closeError.message);
                }
              }
            }
            
            return { success, rainDetected };
          }
          
          /**
           * Main execution
           */
          async function main() {
            console.log('='.repeat(50));
            console.log('üåßÔ∏è RAIN.GG 24/7 MONITOR');
            console.log('='.repeat(50));
            console.log('Start Time:', new Date().toISOString());
            
            try {
              // Check for rain
              const result = await checkForRain();
              
              // Summary
              console.log('='.repeat(50));
              console.log('SUMMARY');
              console.log('='.repeat(50));
              console.log('Status:', result.success ? '‚úÖ SUCCESS' : '‚ùå FAILED');
              console.log('Rain Detected:', result.rainDetected ? '‚úÖ YES' : '‚ùå NO');
              
              // Load and display final stats
              const finalStats = await loadStats();
              console.log('üìä Final Statistics:');
              console.log('   - Total Checks:', finalStats.checks);
              console.log('   - Rain Events:', finalStats.rains);
              console.log('   - Last Rain:', finalStats.lastRain || 'Never');
              console.log('   - Last Check:', finalStats.lastCheck || 'Never');
              
              // Exit with appropriate code
              process.exit(result.success ? 0 : 1);
              
            } catch (fatalError) {
              console.error('üíÄ FATAL ERROR:', fatalError.message);
              console.error(fatalError.stack);
              process.exit(1);
            }
          }
          
          // Execute main function
          if (require.main === module) {
            main();
          }
          
          module.exports = { checkForRain, loadStats, updateHTML };
          EOF
          
          echo "‚úÖ Monitoring script created successfully"
          echo "üìÑ Script size:" $(wc -l < monitor.js) "lines"
      
      - name: üîç Run rain monitor
        id: run-monitor
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "üöÄ Starting rain monitor..."
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          # Run monitor with timeout
          timeout 180s node monitor.js
          EXIT_CODE=$?
          
          echo "Monitor exited with code: $EXIT_CODE"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Monitor completed successfully"
            echo "success=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "‚ö†Ô∏è Monitor timed out (3 minutes)"
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Monitor failed with exit code $EXIT_CODE"
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üíæ Commit and push updates
        if: always()
        run: |
          echo "üì¶ Checking for changes to commit..."
          
          # Configure git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add all modified files
          git add .
          
          # Check if there are changes
          if ! git diff --cached --quiet || ! git diff --quiet; then
            echo "üìù Changes detected, committing..."
            
            # Create commit message
            COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
            COMMIT_MSG="üìä Monitor update $COMMIT_DATE"
            
            git commit -m "$COMMIT_MSG" || echo "Commit may have failed"
            
            # Try to push
            echo "‚¨ÜÔ∏è Pushing changes..."
            git pull --rebase origin main || echo "Pull failed, trying push anyway"
            git push origin main || echo "Push failed"
            
            echo "‚úÖ Changes pushed to repository"
          else
            echo "üì≠ No changes to commit"
          fi
      
      - name: üì§ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-data
          path: |
            stats.json
            monitor.js
            index.html
          retention-days: 7
          if-no-files-found: warn
          compression-level: 9
      
      - name: üìä Create run summary
        if: always()
        run: |
          echo "## üåßÔ∏è Rain Monitor Run Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run completed at:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show stats if available
          if [ -f "stats.json" ]; then
            echo "### üìà Current Statistics" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat stats.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Statistics File Missing" >> $GITHUB_STEP_SUMMARY
            echo "The stats.json file was not created during this run." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This monitor runs automatically every 5 minutes*" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
      
      - name: üßπ Cleanup temporary files
        if: always()
        run: |
          echo "üßπ Cleaning up temporary files..."
          # Remove node_modules to save space
          rm -rf node_modules package-lock.json || true
          echo "‚úÖ Cleanup completed"
