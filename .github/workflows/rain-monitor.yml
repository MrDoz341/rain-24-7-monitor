name: ðŸŒ§ï¸ Rain.gg 24/7 Monitor

on:
  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
  schedule:
    - cron: '*/2 * * * *'
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© GitHub
  workflow_dispatch:
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ push Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯
  push:
    branches: [ main ]

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm init -y
          npm install axios puppeteer cheerio
      
      - name: ðŸš€ Create monitoring script
        run: |
          cat > monitor.js << 'EOF'
          const axios = require('axios');
          const puppeteer = require('puppeteer');
          const fs = require('fs').promises;
          
          // Discord webhook (Ø³ÙŠØªØºÙŠØ± Ù„Ø§Ø­Ù‚Ø§Ù‹)
          const WEBHOOK_URL = process.env.DISCORD_WEBHOOK || '';
          
          // Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          const STATS_FILE = 'stats.json';
          
          async function checkRain() {
            console.log('ðŸŒ¤ï¸ Starting rain check...');
            let browser;
            
            try {
              // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
              let stats = { checks: 0, rains: 0, lastRain: null };
              try {
                const statsData = await fs.readFile(STATS_FILE, 'utf8');
                stats = JSON.parse(statsData);
              } catch (e) {
                console.log('No stats file found, creating new one');
              }
              
              stats.checks++;
              
              // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­ headless
              browser = await puppeteer.launch({
                headless: 'new',
                args: ['--no-sandbox', '--disable-setuid-sandbox']
              });
              
              const page = await browser.newPage();
              
              // ØªØ¹ÙŠÙŠÙ† user-agent Ø·Ø¨ÙŠØ¹ÙŠ
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
              
              // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹
              console.log('ðŸŒ Navigating to rain.gg...');
              await page.goto('https://rain.gg', {
                waitUntil: 'networkidle2',
                timeout: 30000
              });
              
              // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
              await page.waitForTimeout(5000);
              
              // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
              const pageContent = await page.content();
              const pageText = await page.evaluate(() => document.body.innerText);
              
              // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø¯Ø« Ø§Ù„Ù…Ø·Ø±
              const hasUmbrella = pageText.includes('Grab your umbrellas!');
              const hasJoin = pageText.includes('Join free rain') || 
                            pageText.includes('Join now');
              
              const hasRain = hasUmbrella && hasJoin;
              
              console.log(`ðŸ” Check results:`);
              console.log(`   - Umbrella text: ${hasUmbrella}`);
              console.log(`   - Join text: ${hasJoin}`);
              console.log(`   - RAIN DETECTED: ${hasRain}`);
              
              // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ù…Ø·Ø±Ø§Ù‹
              if (hasRain) {
                stats.rains++;
                stats.lastRain = new Date().toISOString();
                
                console.log('ðŸŒ§ï¸ RAIN DETECTED!');
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Discord Ø¥Ø°Ø§ ÙƒØ§Ù† Webhook Ù…ÙˆØ¬ÙˆØ¯
                if (WEBHOOK_URL) {
                  try {
                    await axios.post(WEBHOOK_URL, {
                      content: "@everyone ðŸš¨ **RAIN IS LIVE ON RAIN.GG!** ðŸš¨",
                      embeds: [{
                        title: "ðŸŒ§ï¸ RAIN EVENT DETECTED!",
                        description: "Quick! Go to rain.gg to join the rain!",
                        color: 3066993,
                        timestamp: new Date().toISOString(),
                        url: "https://rain.gg",
                        footer: { text: "GitHub Actions Monitor â€¢ Auto-detected" }
                      }]
                    });
                    console.log('âœ… Discord notification sent');
                  } catch (error) {
                    console.log('âŒ Failed to send Discord notification:', error.message);
                  }
                }
              }
              
              // Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              await fs.writeFile(STATS_FILE, JSON.stringify(stats, null, 2));
              
              // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© HTML
              await updateHTML(stats);
              
              console.log(`ðŸ“Š Stats updated: ${stats.checks} checks, ${stats.rains} rains detected`);
              
              return { detected: hasRain, stats };
              
            } catch (error) {
              console.error('âŒ Error during check:', error.message);
              return { error: error.message };
            } finally {
              if (browser) {
                await browser.close();
              }
            }
          }
          
          async function updateHTML(stats) {
            try {
              // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù HTML Ø§Ù„Ø­Ø§Ù„ÙŠ
              let html = await fs.readFile('index.html', 'utf8');
              
              // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ÙØ­Øµ
              const now = new Date();
              const timeStr = now.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
              });
              
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ HTML
              html = html.replace(
                /id="lastCheck">.*?</,
                `id="lastCheck">${timeStr}<`
              );
              
              html = html.replace(
                /id="rainCount">\d+</,
                `id="rainCount">${stats.rains}<`
              );
              
              if (stats.lastRain) {
                const lastRainDate = new Date(stats.lastRain);
                const lastRainStr = lastRainDate.toLocaleString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                html = html.replace(
                  /id="lastRain">.*?</,
                  `id="lastRain">${lastRainStr}<`
                );
              }
              
              // ÙƒØªØ§Ø¨Ø© HTML Ø§Ù„Ù…Ø­Ø¯Ø«
              await fs.writeFile('index.html', html);
              console.log('âœ… HTML page updated');
              
            } catch (error) {
              console.log('âŒ Error updating HTML:', error.message);
            }
          }
          
          // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          (async () => {
            const result = await checkRain();
            console.log('ðŸ Monitor check completed');
            process.exit(result.error ? 1 : 0);
          })();
          EOF
      
      - name: ðŸ” Run rain check
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: node monitor.js
      
      - name: ðŸ’¾ Commit and push updates
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªØºÙŠØ±Øª
          git add index.html stats.json 2>/dev/null || echo "No files to add"
          
          # Ø¹Ù…Ù„ commit Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update monitor stats - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "âœ… Changes pushed to GitHub"
          fi
      
      - name: ðŸ“¤ Upload stats as artifact
        uses: actions/upload-artifact@v3
        with:
          name: monitor-stats
          path: |
            stats.json
          retention-days: 7
