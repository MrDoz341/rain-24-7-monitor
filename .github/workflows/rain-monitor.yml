name: ğŸŒ§ï¸ Rain.gg 24/7 Monitor

on:
  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  schedule:
    - cron: '*/5 * * * *'
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯
  push:
    branches: [ main ]

# Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ package.json Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
          if [ ! -f package.json ]; then
            echo '{
              "name": "rain-monitor",
              "version": "1.0.0",
              "description": "24/7 Rain.gg Monitor",
              "main": "monitor.js",
              "scripts": {
                "start": "node monitor.js"
              },
              "dependencies": {
                "axios": "^1.6.0",
                "puppeteer": "^21.0.0"
              },
              "engines": {
                "node": ">=18.0.0"
              }
            }' > package.json
          fi
          
          # Ø¥Ù†Ø´Ø§Ø¡ package-lock.json Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
          npm init -y --silent
          
          # ØªØ«Ø¨ÙŠØª puppeteer Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
          npm install puppeteer@21.0.0 --no-save
          npm install axios@1.6.0 --no-save
          
          # ØªØ«Ø¨ÙŠØª Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù€ puppeteer
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates fonts-liberation \
            libappindicator3-1 libasound2 libatk-bridge2.0-0 libatk1.0-0 \
            libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 \
            libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 \
            libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 \
            libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 \
            libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 \
            libxtst6 lsb-release xdg-utils
      
      - name: ğŸš€ Create monitoring script
        run: |
          cat > monitor.js << 'EOF'
          const axios = require('axios');
          const puppeteer = require('puppeteer');
          const fs = require('fs').promises;
          const path = require('path');
          
          // Discord webhook (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          const WEBHOOK_URL = process.env.DISCORD_WEBHOOK || '';
          
          // Ù…Ù„Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          const STATS_FILE = 'stats.json';
          
          async function initStats() {
            try {
              await fs.access(STATS_FILE);
              const data = await fs.readFile(STATS_FILE, 'utf8');
              return JSON.parse(data);
            } catch (error) {
              // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯
              const initialStats = {
                checks: 0,
                rains: 0,
                lastRain: null,
                lastCheck: null,
                createdAt: new Date().toISOString()
              };
              await fs.writeFile(STATS_FILE, JSON.stringify(initialStats, null, 2));
              return initialStats;
            }
          }
          
          async function updateStats(newStats) {
            try {
              const stats = await initStats();
              const updated = {
                ...stats,
                ...newStats,
                lastCheck: new Date().toISOString()
              };
              await fs.writeFile(STATS_FILE, JSON.stringify(updated, null, 2));
              return updated;
            } catch (error) {
              console.error('Error updating stats:', error.message);
              return null;
            }
          }
          
          async function checkRain() {
            console.log('ğŸš€ Starting rain check at:', new Date().toISOString());
            let browser = null;
            
            try {
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„ÙØ­ÙˆØµØ§Øª
              const stats = await initStats();
              stats.checks = (stats.checks || 0) + 1;
              
              console.log('ğŸŒ Launching browser...');
              
              // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¨Ø³Ø·Ø©
              browser = await puppeteer.launch({
                headless: 'new',
                args: [
                  '--no-sandbox',
                  '--disable-setuid-sandbox',
                  '--disable-dev-shm-usage',
                  '--disable-gpu',
                  '--disable-web-security',
                  '--disable-features=IsolateOrigins,site-per-process'
                ],
                timeout: 30000
              });
              
              const page = await browser.newPage();
              
              // ØªØ¹ÙŠÙŠÙ† user-agent Ø¹Ø§Ø¯ÙŠ
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
              
              // Ø²ÙŠØ§Ø¯Ø© Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
              await page.setDefaultNavigationTimeout(45000);
              await page.setDefaultTimeout(45000);
              
              console.log('ğŸ“¡ Navigating to rain.gg...');
              
              // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹
              try {
                await page.goto('https://rain.gg', {
                  waitUntil: 'domcontentloaded',
                  timeout: 45000
                });
              } catch (navError) {
                console.log('Navigation timeout, trying load event...');
                await page.goto('https://rain.gg', {
                  waitUntil: 'load',
                  timeout: 30000
                });
              }
              
              // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
              await page.waitForTimeout(5000);
              
              // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
              const pageText = await page.evaluate(() => {
                return document.body.innerText || document.body.textContent || '';
              });
              
              // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø¯Ø« Ø§Ù„Ù…Ø·Ø±
              const hasUmbrella = pageText.includes('Grab your umbrellas!');
              const hasJoin = pageText.includes('Join free rain') || 
                            pageText.includes('Join now') ||
                            pageText.includes('Join the rain');
              
              console.log('ğŸ” Scan results:');
              console.log('  - Umbrella text found:', hasUmbrella);
              console.log('  - Join text found:', hasJoin);
              
              const hasRain = hasUmbrella && hasJoin;
              
              if (hasRain) {
                console.log('ğŸ‰ RAIN DETECTED!');
                stats.rains = (stats.rains || 0) + 1;
                stats.lastRain = new Date().toISOString();
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Discord Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (WEBHOOK_URL && WEBHOOK_URL.includes('discord.com')) {
                  try {
                    console.log('ğŸ“¨ Sending Discord notification...');
                    await axios.post(WEBHOOK_URL, {
                      content: "ğŸŒ§ï¸ **RAIN DETECTED ON RAIN.GG!**",
                      embeds: [{
                        title: "Quick! Join Now!",
                        description: "Rain event is live on rain.gg",
                        color: 3066993,
                        url: "https://rain.gg",
                        timestamp: new Date().toISOString(),
                        footer: {
                          text: "GitHub Actions Monitor â€¢ Auto-detected"
                        }
                      }]
                    }, { timeout: 10000 });
                    console.log('âœ… Discord notification sent');
                  } catch (discordError) {
                    console.log('âš ï¸ Could not send Discord notification:', discordError.message);
                  }
                }
              } else {
                console.log('â˜€ï¸ No rain detected');
              }
              
              // Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
              await updateStats(stats);
              
              // ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© HTML
              await updateHTML(stats);
              
              console.log('ğŸ“Š Final stats:', {
                checks: stats.checks,
                rains: stats.rains,
                lastRain: stats.lastRain || 'Never'
              });
              
              return {
                success: true,
                rainDetected: hasRain,
                stats: stats
              };
              
            } catch (error) {
              console.error('âŒ Error during monitoring:', error.message);
              console.error('Stack:', error.stack);
              
              // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø§Ù„ÙØ§Ø´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              try {
                const stats = await initStats();
                stats.checks = (stats.checks || 0) + 1;
                await updateStats(stats);
              } catch (statsError) {
                console.log('Could not update error stats:', statsError.message);
              }
              
              return {
                success: false,
                error: error.message
              };
              
            } finally {
              if (browser) {
                try {
                  await browser.close();
                  console.log('ğŸ”’ Browser closed');
                } catch (closeError) {
                  console.log('Warning: Could not close browser properly');
                }
              }
            }
          }
          
          async function updateHTML(stats) {
            try {
              let html = '';
              const htmlPath = 'index.html';
              
              // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù HTML Ø§Ù„Ø­Ø§Ù„ÙŠ
              try {
                html = await fs.readFile(htmlPath, 'utf8');
              } catch (error) {
                console.log('index.html not found, creating basic one');
                html = `
                <!DOCTYPE html>
                <html>
                <head>
                  <meta charset="UTF-8">
                  <title>Rain Monitor</title>
                  <style>
                    body { font-family: Arial; padding: 20px; }
                    .status { color: green; font-weight: bold; }
                  </style>
                </head>
                <body>
                  <h1>ğŸŒ§ï¸ Rain.gg Monitor</h1>
                  <p>Last check: <span id="lastCheck">Loading...</span></p>
                  <p>Rain events: <span id="rainCount">0</span></p>
                  <p>Total checks: <span id="totalChecks">0</span></p>
                  <p>Last rain: <span id="lastRain">Never</span></p>
                </body>
                </html>
                `;
              }
              
              // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
              const formatTime = (dateStr) => {
                if (!dateStr) return 'Never';
                try {
                  const date = new Date(dateStr);
                  return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                  });
                } catch {
                  return dateStr;
                }
              };
              
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ HTML
              const lastCheckTime = formatTime(new Date().toISOString());
              html = html.replace(
                /id="lastCheck"[^>]*>([^<]*)</,
                `id="lastCheck">${lastCheckTime}<`
              );
              
              const rainCount = stats.rains || 0;
              html = html.replace(
                /id="rainCount"[^>]*>([^<]*)</,
                `id="rainCount">${rainCount}<`
              );
              
              const totalChecks = stats.checks || 0;
              html = html.replace(
                /id="totalChecks"[^>]*>([^<]*)</,
                `id="totalChecks">${totalChecks}<`
              );
              
              const lastRainTime = formatTime(stats.lastRain);
              html = html.replace(
                /id="lastRain"[^>]*>([^<]*)</,
                `id="lastRain">${lastRainTime}<`
              );
              
              // Ø­ÙØ¸ HTML Ø§Ù„Ù…Ø­Ø¯Ø«
              await fs.writeFile(htmlPath, html);
              console.log('âœ… HTML page updated');
              
            } catch (error) {
              console.log('âš ï¸ Could not update HTML:', error.message);
            }
          }
          
          // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          (async () => {
            console.log('========================================');
            console.log('ğŸŒ§ï¸ RAIN.GG 24/7 MONITOR STARTING');
            console.log('========================================');
            
            const result = await checkRain();
            
            console.log('========================================');
            console.log('ğŸ MONITOR COMPLETED');
            console.log('Status:', result.success ? 'SUCCESS' : 'FAILED');
            if (result.rainDetected) console.log('ğŸ‰ RAIN WAS DETECTED!');
            console.log('========================================');
            
            // Ø¥Ø¹Ø·Ø§Ø¡ ÙˆÙ‚Øª Ù„Ù„Ø¥ØºÙ„Ø§Ù‚
            setTimeout(() => {
              process.exit(result.success ? 0 : 1);
            }, 1000);
            
          })();
          EOF
          
          echo "âœ… Monitoring script created"
      
      - name: ğŸ” Run rain check
        id: monitor
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "ğŸš€ Starting monitor script..."
          timeout 120s node monitor.js
          MONITOR_EXIT=$?
          
          if [ $MONITOR_EXIT -eq 124 ]; then
            echo "âš ï¸ Monitor timed out after 2 minutes"
          elif [ $MONITOR_EXIT -ne 0 ]; then
            echo "âŒ Monitor failed with exit code $MONITOR_EXIT"
          else
            echo "âœ… Monitor completed successfully"
          fi
      
      - name: ğŸ’¾ Commit and push changes
        if: always()
        run: |
          echo "ğŸ“¦ Preparing to commit changes..."
          
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªØºÙŠØ±Øª
          git add index.html stats.json 2>/dev/null || echo "No HTML/stats to add"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
          if ! git diff --cached --quiet || ! git diff --quiet; then
            echo "ğŸ“ Changes detected, committing..."
            git commit -m "ğŸ“Š Monitor update $(date +'%Y-%m-%d %H:%M:%S')" || echo "Commit failed"
            git pull --rebase || echo "Rebase failed, continuing"
            git push || echo "Push failed"
            echo "âœ… Changes pushed to repository"
          else
            echo "ğŸ“­ No changes to commit"
          fi
      
      - name: ğŸ“¤ Upload artifact (v4)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-data
          path: |
            stats.json
            monitor.js
          if-no-files-found: warn
          retention-days: 3
      
      - name: ğŸ“Š Create summary report
        if: always()
        run: |
          echo "## ğŸ“ˆ Rain Monitor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "stats.json" ]; then
            echo "### ğŸ“Š Current Statistics" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat stats.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No Statistics File" >> $GITHUB_STEP_SUMMARY
            echo "Stats file not found or not created." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
