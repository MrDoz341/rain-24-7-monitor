name: ðŸŒ§ï¸ Rain.gg 24/7 Monitor

on:
  schedule:
    - cron: '*/2 * * * *'  # ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
  
  workflow_dispatch:  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  push:
    branches: [ main ]

# Ø£Ø°ÙˆÙ†Ø§Øª Ù„Ù„Ù€ GITHUB_TOKEN
permissions:
  contents: write
  actions: read

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm init -y -q
          npm install axios puppeteer cheerio
      
      - name: ðŸš€ Create monitoring script
        run: |
          cat > monitor.js << 'EOF'
          const axios = require('axios');
          const puppeteer = require('puppeteer');
          const fs = require('fs').promises;
          
          const WEBHOOK_URL = process.env.DISCORD_WEBHOOK || '';
          const STATS_FILE = 'stats.json';
          
          async function checkRain() {
            console.log('ðŸŒ¤ï¸ Starting rain check...');
            let browser;
            
            try {
              // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              let stats = { checks: 0, rains: 0, lastRain: null, lastCheck: new Date().toISOString() };
              try {
                const statsData = await fs.readFile(STATS_FILE, 'utf8');
                stats = JSON.parse(statsData);
                stats.checks = (stats.checks || 0) + 1;
              } catch (e) {
                console.log('Creating new stats file');
                stats.checks = 1;
              }
              
              browser = await puppeteer.launch({
                headless: 'new',
                args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
              });
              
              const page = await browser.newPage();
              
              // ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
              
              // Ø²ÙŠØ§Ø¯Ø© timeout
              await page.setDefaultNavigationTimeout(60000);
              
              console.log('ðŸŒ Navigating to rain.gg...');
              await page.goto('https://rain.gg', {
                waitUntil: 'domcontentloaded',
                timeout: 45000
              });
              
              // Ø§Ù†ØªØ¸Ø§Ø± Ø£Ø°ÙƒÙ‰
              await Promise.race([
                page.waitForSelector('body', { timeout: 10000 }),
                page.waitForTimeout(8000)
              ]);
              
              const pageText = await page.evaluate(() => document.body.innerText);
              
              const hasRain = pageText.includes('Grab your umbrellas!') && 
                            (pageText.includes('Join free rain') || pageText.includes('Join now'));
              
              console.log(`ðŸ” Rain detected: ${hasRain}`);
              
              if (hasRain && WEBHOOK_URL) {
                stats.rains = (stats.rains || 0) + 1;
                stats.lastRain = new Date().toISOString();
                
                try {
                  await axios.post(WEBHOOK_URL, {
                    content: "ðŸŒ§ï¸ **RAIN DETECTED ON RAIN.GG!**",
                    embeds: [{
                      title: "Quick! Join the Rain!",
                      url: "https://rain.gg",
                      color: 3066993,
                      timestamp: new Date().toISOString()
                    }]
                  }, { timeout: 5000 });
                  console.log('âœ… Discord notification sent');
                } catch (error) {
                  console.log('âš ï¸ Could not send Discord notification');
                }
              }
              
              stats.lastCheck = new Date().toISOString();
              await fs.writeFile(STATS_FILE, JSON.stringify(stats, null, 2));
              
              await updateHTML(stats);
              
              console.log(`ðŸ“Š Stats: ${stats.checks} checks, ${stats.rains} rains`);
              
              return { detected: hasRain, stats };
              
            } catch (error) {
              console.error('âŒ Error:', error.message);
              return { error: error.message };
            } finally {
              if (browser) await browser.close();
            }
          }
          
          async function updateHTML(stats) {
            try {
              let html = await fs.readFile('index.html', 'utf8');
              
              const now = new Date();
              const timeStr = now.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
              });
              
              // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„ÙØ­Øµ
              html = html.replace(
                /id="lastCheck">[^<]*</,
                `id="lastCheck">${timeStr}<`
              );
              
              // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ù…Ø·Ø±
              html = html.replace(
                /id="rainCount">\d+</,
                `id="rainCount">${stats.rains || 0}<`
              );
              
              // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù…Ø·Ø±
              if (stats.lastRain) {
                const lastRainDate = new Date(stats.lastRain);
                const lastRainStr = lastRainDate.toLocaleString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                html = html.replace(
                  /id="lastRain">[^<]*</,
                  `id="lastRain">${lastRainStr}<`
                );
              } else {
                html = html.replace(
                  /id="lastRain">[^<]*</,
                  `id="lastRain">Never<`
                );
              }
              
              await fs.writeFile('index.html', html);
              console.log('âœ… HTML updated');
              
            } catch (error) {
              console.log('âš ï¸ Could not update HTML');
            }
          }
          
          // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          (async () => {
            const result = await checkRain();
            console.log('ðŸ Check completed');
            process.exit(result.error ? 1 : 0);
          })();
          EOF
      
      - name: ðŸ” Run rain check
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: node monitor.js
        timeout-minutes: 3  # Ù…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¯
      
      - name: ðŸ’¾ Commit updates
        if: always()
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add -A
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update: $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Changes pushed"
          fi
      
      - name: ðŸ“¤ Upload artifact (v4 Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        if: always()
        uses: actions/upload-artifact@v4  # âš ï¸ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ v4
        with:
          name: monitor-data
          path: |
            stats.json
            monitor.js
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“ Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Monitor Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "stats.json" ]; then
            echo "âœ… Stats file updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "```json" >> $GITHUB_STEP_SUMMARY
            cat stats.json >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No stats file created" >> $GITHUB_STEP_SUMMARY
          fi
